(function(){var e;var t=function(){};var n=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];var r=n.length;var i=window.console=window.console||{};while(r--){e=n[r];if(!i[e]){i[e]=t}}})();var ActionModel=Backbone.Model.extend({defaults:{name:"",occurrences:0,period:"",minutes:0,total_points:0},initialize:function(){this.on("invalid",function(e,t){console.log("action model init",t)})}});var allActionsCollection;var PlayerActionsCollection=Backbone.Collection.extend({model:ActionModel});var matchesCollection=new Backbone.Collection;var teamCollection=new Backbone.Collection;var PlayerView=Backbone.Marionette.ItemView.extend({tagName:"a",template:"#player-row-template",actionsCollection:null,initialize:function(){this.actionsCollection=this.model.get("actionsCollection");this.listenTo(this.actionsCollection,"add",this.actionAdded)},actionAdded:function(e,t){var n=this.model.get("points");n=n+e.get("total_points");this.model.set("points",n);this.render()}});var MatchNoticeView=Backbone.Marionette.ItemView.extend({tagName:"a",className:"match-notice",template:"#match-notice-template",events:{click:"setTime"},setTime:function(){simTime=this.model.get("played_on")}});var ActionNoticeView=Backbone.Marionette.ItemView.extend({template:"#action-notice-template",className:"latest",onRender:function(){var e=this.model.get("action_name").replace(/ /g,"-");this.$(".match-icon").addClass(e)}});var ActionsDetailView=Backbone.Marionette.ItemView.extend({template:"#actions-detail-template",className:"actions-detail",initialize:function(){this.listenTo(this.collection,"add",this.actionAdded);this.listenTo(App,"ticked",this.updateMatchDuration)},actionAdded:function(e,t){this.render()},updateMatchDuration:function(){var e=Math.floor((simTime-this.model.get("played_on"))/6e4);var t="";if(e<91){if(e<46){t=" (First half: "+e+" min)"}else{t=" (Second half: "+(e-45)+" min)"}this.$(".duration").html(t)}else{this.$(".duration").html("  (Match over)")}},onDomRefresh:function(){var e=this.$el.width();App.createGraph("graph-container-firsthalf",e,1,45,this.collection);App.createGraph("graph-container-secondhalf",e,46,90,this.collection)}});var PlayerLayout=Backbone.Marionette.Layout.extend({template:"#player-layout",className:"player-container",regions:{head:"#head",latest:"#latest"},events:{"click #head":"showDetail"},actionsCollection:null,initialize:function(){this.actionsCollection=this.model.get("actionsCollection");this.listenTo(this.actionsCollection,"add",this.actionAdded);this.listenTo(App,"detail:close",this.closeDetail)},showDetail:function(){App.trigger("detail:show");this.addRegion("detail","#detail");this.detail.show(new ActionsDetailView({model:this.model.get("match"),collection:this.model.get("actionsCollection")}))},closeDetail:function(){if(this.detail){this.removeRegion("detail","#detail")}},actionAdded:function(){this.latest.show(new ActionNoticeView({model:this.actionsCollection.at(this.actionsCollection.length-1)}))},onShow:function(){this.head.show(new PlayerView({model:this.model}));this.latest.show(new MatchNoticeView({model:this.model.get("match")}))}});var teamView=new Backbone.Marionette.CompositeView({template:"#team-overview-template",itemView:PlayerLayout,itemViewContainer:".rows",collection:teamCollection});var appContainer=new Backbone.Marionette.Region({el:"#wrapper"});var AppLayout=Backbone.Marionette.Layout.extend({template:"#app-layout",regions:{clock:"#clock",team:"#team"}});var layout=new AppLayout;layout.render();appContainer.show(layout);layout.team.show(teamView);var simTime=137607371e4;var interval=10;var App=new Backbone.Marionette.Application;App.on("detail:show",function(){this.trigger("detail:close")});App.addInitializer(function(e){this.setupModels(dataJSON);this.tick()});App.tick=function(){simTime=simTime+1e3;$("#clock").text((new Date(simTime)).toUTCString());var e=allActionsCollection.where({timestamp:simTime});for(var t=0;t<e.length;t++){App.addActionToPlayer(e[t].clone())}App.trigger("ticked");setTimeout(App.tick,interval)};App.setupModels=function(e){allActionsCollection=new Backbone.Collection(e.actions);for(var t=0;t<e.actions.length;t++){var n=e.actions[t];var r=allActionsCollection.at(t);var i=r.get("action_name").replace(/_/g," ");r.set("action_name",i);var s=n.match;s.played_on_UTC=(new Date(s.played_on)).toUTCString();var o=matchesCollection.where({home_squad:s.home_squad,away_squad:s.away_squad});if(o.length===0){matchesCollection.add(s)}var u=teamCollection.where({name:n.player_name});if(u.length===0){var a={name:n.player_name,id:n.player_id,squad:n.squad_id?n.squad_id:n.squad,points:0,lastaction:"",match:new Backbone.Model(s),actionsCollection:new PlayerActionsCollection};teamCollection.add(a)}}};App.addActionToPlayer=function(e){var t=teamCollection.findWhere({name:e.get("player_name")});var n=t.get("actionsCollection");n.add(e)};App.createGraph=function(e,t,n,r,i){var s=Raphael(e,t-50,260);var o=[];var u=[];for(var a=n;a<=r;a++){o.push(a);var f=i.where({minutes:a});var l=0;for(var c=0;c<f.length;c++){l=l+f[c].get("total_points")}u.push(l)}var h=s.linechart(50,60,t-60,200,o,u,{nostroke:true,axis:"0 0 0 0",symbol:"circle",smooth:false}).hoverColumn(function(){this.tags=s.set();for(var e=0,t=this.y.length;e<t;e++){var n=this.axis+" min";if(this.values[e]!==0){n=n+": "+this.values[e]+" pts"}this.tags.push(s.tag(this.x,this.y[e],n,140,10).insertBefore(this).attr([{fill:"#fff"},{fill:this.symbols[e].attr("fill")}]))}},function(){this.tags&&this.tags.remove()});h.symbols.attr({r:4})};App.start()